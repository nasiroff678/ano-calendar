<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –ê–ù–û</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ano: {
                            bg: '#fcfcf9',
                            text: '#134252',
                            primary: '#208091',
                            success: '#208091',
                            warning: '#a84b2f',
                            error: '#c01530',
                            surface: '#ffffff'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #fcfcf9;
            color: #134252;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #208091; 
            border-radius: 4px;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        /* File Upload Styles */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #208091;
            background-color: #f0f9fa;
        }
        
        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 200ms, transform 200ms;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white;
            }
            .card-shadow {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
            /* Hide status selector in print */
            #modalStatusSelect {
                display: none !important;
            }
            #modalStatusBadge {
                display: inline-block !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-[#134252] to-[#208091] text-white p-6 shadow-lg no-print">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold mb-2">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –ê–ù–û</h1>
            <p class="opacity-90 text-sm md:text-base">–£–°–ù 6% (–î–æ—Ö–æ–¥—ã) | –ê–ù–û "–ù–æ–≤—ã–µ –ì–æ—Ä–∏–∑–æ–Ω—Ç—ã"</p>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        
        <!-- Controls & Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Controls Panel -->
            <div class="lg:col-span-4 bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-wrap items-center gap-4 no-print">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-semibold text-gray-500 mb-1">–§–ò–õ–¨–¢–† –ü–û –ú–ï–°–Ø–¶–£</label>
                    <input type="month" id="monthFilter" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#208091] outline-none text-[#134252]">
                </div>
                
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-semibold text-gray-500 mb-1">–°–¢–ê–¢–£–°</label>
                    <select id="statusFilter" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#208091] outline-none text-[#134252] bg-white">
                        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="pending">üìã –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</option>
                        <option value="process">‚è≥ –í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="done">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
                        <option value="payment">‚ö†Ô∏è –û–ø–ª–∞—Ç–∞</option>
                    </select>
                </div>

                <div class="flex gap-2 min-w-[150px]">
                    <button onclick="app.setView('table')" id="btnTable" class="flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-[#208091] text-white shadow-sm hover:bg-[#186572]">
                        <i class="fas fa-table mr-2"></i>–¢–∞–±–ª–∏—Ü–∞
                    </button>
                    <button onclick="app.setView('timeline')" id="btnTimeline" class="flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-white text-[#134252] border border-gray-300 hover:bg-gray-50">
                        <i class="fas fa-stream mr-2"></i>–¢–∞–π–º–ª–∞–π–Ω
                    </button>
                </div>

                <div>
                    <button onclick="window.print()" class="py-2 px-4 rounded-lg font-medium transition-colors text-[#134252] hover:bg-gray-100" title="–ü–µ—á–∞—Ç—å">
                        <i class="fas fa-print text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="lg:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-[#208091] flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">–í—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤</p>
                        <p class="text-2xl font-bold text-[#134252]" id="statTotal">0</p>
                    </div>
                    <div class="bg-cyan-50 p-3 rounded-full text-[#208091]">
                        <i class="fas fa-file-invoice text-xl"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-[#a84b2f] flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">–í —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ</p>
                        <p class="text-2xl font-bold text-[#134252]" id="statMonth">0</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-full text-[#a84b2f]">
                        <i class="fas fa-calendar-day text-xl"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-[#c01530] flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">–î–æ –∫–æ–Ω—Ü–∞ –∫–≤–∞—Ä—Ç–∞–ª–∞</p>
                        <p class="text-2xl font-bold text-[#134252]" id="statQuarter">0</p>
                    </div>
                    <div class="bg-red-50 p-3 rounded-full text-[#c01530]">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Notification -->
        <div id="filterNotification" class="hidden mb-4 p-3 bg-blue-50 text-blue-800 rounded-lg border border-blue-200 text-sm flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            <span id="filterMsg"></span>
        </div>

        <!-- Main Content Area -->
        <div id="viewContainer" class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden min-h-[400px]">
            <!-- Content injected by JS -->
        </div>

    </main>

    <!-- Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300" onclick="app.closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-gray-100 p-6 flex flex-col sm:flex-row justify-between items-start z-10 gap-4">
                <div class="flex-grow">
                    <!-- Status Selector -->
                    <div class="mb-2 flex items-center gap-2">
                        <select id="modalStatusSelect" onchange="app.changeStatus(this.value)" class="text-sm font-semibold rounded-full px-3 py-1 border-2 outline-none cursor-pointer transition-colors"></select>
                    </div>
                    
                    <h2 id="modalTitle" class="text-2xl font-bold text-[#134252] leading-tight"></h2>
                    <p id="modalSubtitle" class="text-gray-500 mt-1"></p>
                </div>
                <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 absolute top-4 right-4 sm:static">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 space-y-6" id="modalBody">
                <!-- Dynamic Content -->
            </div>

            <!-- Documents Section -->
            <div class="px-6 pb-6 border-t border-gray-100 pt-4">
                <h3 class="font-bold text-lg mb-3 text-[#134252]">üìÇ –î–æ–∫—É–º–µ–Ω—Ç—ã</h3>
                
                <!-- File List -->
                <div id="fileList" class="space-y-2 mb-4">
                    <!-- Files will be injected here -->
                    <div class="text-center py-4 text-gray-400 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="upload-zone rounded-lg p-6 text-center cursor-pointer relative" id="dropZone">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="app.handleFileUpload(this)">
                    <div class="text-gray-500">
                        <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-[#208091]"></i>
                        <p class="text-sm font-medium">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</p>
                        <p class="text-xs text-gray-400 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ –±—Ä–∞—É–∑–µ—Ä–∞)</p>
                    </div>
                </div>
                <div id="uploadError" class="text-red-500 text-xs mt-2 hidden"></div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 p-6 border-t border-gray-100 flex justify-end">
                <button onclick="app.closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Database Helper (IndexedDB) ---
        // –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π localStorage (5MB)
        const db = {
            dbName: 'AnoCalendarDB',
            version: 1,
            instance: null,
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('reportId', 'reportId', { unique: false });
                        }
                    };
                    
                    request.onsuccess = (e) => {
                        this.instance = e.target.result;
                        resolve();
                    };
                    
                    request.onerror = (e) => {
                        console.error("DB Error", e);
                        reject(e);
                    };
                });
            },

            async addFile(fileData) {
                return new Promise((resolve, reject) => {
                    const tx = this.instance.transaction(['files'], 'readwrite');
                    const store = tx.objectStore('files');
                    const req = store.add(fileData);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },

            async getFilesByReportId(reportId) {
                return new Promise((resolve, reject) => {
                    if (!this.instance) {
                        resolve([]); 
                        return;
                    }
                    const tx = this.instance.transaction(['files'], 'readonly');
                    const store = tx.objectStore('files');
                    const index = store.index('reportId');
                    const req = index.getAll(reportId);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },

            async deleteFile(id) {
                 return new Promise((resolve, reject) => {
                    const tx = this.instance.transaction(['files'], 'readwrite');
                    const store = tx.objectStore('files');
                    const req = store.delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },

            async countFilesByReportId(reportId) {
                return new Promise((resolve, reject) => {
                    if (!this.instance) {
                        resolve(0);
                        return;
                    }
                    const tx = this.instance.transaction(['files'], 'readonly');
                    const store = tx.objectStore('files');
                    const index = store.index('reportId');
                    const req = index.count(reportId);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(0); // Safely return 0 on error
                });
            }
        };

        // --- Data ---
        const initialReports = [
            // –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (2025)
            { id: 1, date: '2025-03-25', title: '–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è –£–°–ù 2024', where: '–§–ù–°', status: 'done', comment: '–°–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ' },
            { id: 2, date: '2025-04-25', title: '–†–°–í –∑–∞ 1 –∫–≤–∞—Ä—Ç–∞–ª 2025', where: '–§–ù–°', status: 'done', comment: '–ù—É–ª–µ–≤–æ–π –æ—Ç—á–µ—Ç' },
            { id: 3, date: '2025-05-20', title: '–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è (–ê–ø—Ä–µ–ª—å)', where: '–§–ù–°', status: 'done', comment: '–ë–µ–∑ –≤—ã–ø–ª–∞—Ç' },
            { id: 4, date: '2025-06-04', title: '–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è (–ú–∞–π)', where: '–§–ù–°', status: 'done', comment: '' },
            { id: 5, date: '2025-07-15', title: '–ï–§–°-1 –∑–∞ –ø–æ–ª—É–≥–æ–¥–∏–µ 2025', where: '–°–§–†', status: 'done', comment: '–†–∞–∑–¥–µ–ª 2' },
            { id: 6, date: '2025-07-15', title: '–†–°–í –∑–∞ –ø–æ–ª—É–≥–æ–¥–∏–µ 2025', where: '–§–ù–°', status: 'done', comment: '' },
            { id: 7, date: '2025-10-30', title: '–†–°–í –∑–∞ 9 –º–µ—Å—è—Ü–µ–≤ 2025', where: '–§–ù–°', status: 'done', comment: '' },
            
            // –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ (2026)
            { id: 8, date: '2026-01-26', title: '–ï–§–°-1 –∑–∞ 2025 –≥–æ–¥', where: '–°–§–†', status: 'pending', comment: '–¢—Ä–∞–≤–º–∞—Ç–∏–∑–º' },
            { id: 9, date: '2026-01-30', title: '–†–°–í –∑–∞ 2025 –≥–æ–¥', where: '–§–ù–°', status: 'pending', comment: '–ì–æ–¥–æ–≤–æ–π —Ä–∞—Å—á–µ—Ç' },
            { id: 10, date: '2026-03-25', title: '–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è –£–°–ù 2025 (–ö–†–ò–¢–ò–ß–ù–û)', where: '–§–ù–°', status: 'pending', isCritical: true, comment: '–í–∞–∂–Ω—ã–π –æ—Ç—á–µ—Ç' },
            { id: 11, date: '2026-03-28', title: '–£–ø–ª–∞—Ç–∞ –Ω–∞–ª–æ–≥–∞ –£–°–ù', where: '–ë–∞–Ω–∫', status: 'payment', amount: '16 200 ‚ÇΩ', comment: '–ó–∞ 2025 –≥–æ–¥' },
            { id: 12, date: '2026-03-31', title: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å', where: '–§–ù–° / –ì–ò–† –ë–û', status: 'pending', comment: '–ë–∞–ª–∞–Ω—Å –∏ –æ—Ç—á–µ—Ç –æ —Ü.–∏.' },
            { id: 13, date: '2026-04-15', title: '–û—Ç—á—ë—Ç –≤ –ú–∏–Ω—é—Å—Ç', where: '–ú–∏–Ω—é—Å—Ç', status: 'pending', comment: '–§–æ—Ä–º–∞ –û–ù0001 –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ' },
            { id: 14, date: '2026-04-30', title: '–†–°–í –∑–∞ 1 –∫–≤–∞—Ä—Ç–∞–ª 2026', where: '–§–ù–°', status: 'pending', comment: '' },
            { id: 15, date: '2026-07-25', title: '–ï–§–°-1 –∑–∞ –ø–æ–ª—É–≥–æ–¥–∏–µ 2026', where: '–°–§–†', status: 'pending', comment: '' },
            { id: 16, date: '2026-07-30', title: '–†–°–í –∑–∞ –ø–æ–ª—É–≥–æ–¥–∏–µ 2026', where: '–§–ù–°', status: 'pending', comment: '' },
            { id: 17, date: '2026-10-30', title: '–†–°–í –∑–∞ 9 –º–µ—Å—è—Ü–µ–≤ 2026', where: '–§–ù–°', status: 'pending', comment: '' },
            { id: 18, date: '2027-01-30', title: '–†–°–í –∑–∞ 2026 –≥–æ–¥', where: '–§–ù–°', status: 'pending', comment: '' }
        ];

        // --- Detailed Content Templates ---
        const contentTemplates = {
            'usn2025': `
                <div class="space-y-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <p class="font-bold text-yellow-800">‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –æ—Ç—á—ë—Ç</p>
                        <p class="text-sm text-yellow-700">–ü—Ä–æ–ø—É—Å–∫ —Å—Ä–æ–∫–∞ –≥—Ä–æ–∑–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Å—á—ë—Ç–∞.</p>
                    </div>
                    
                    <h3 class="font-bold text-lg border-b pb-2">üßÆ –†–∞—Å—á—ë—Ç –Ω–∞–ª–æ–≥–∞</h3>
                    <div class="bg-gray-50 p-3 rounded font-mono text-sm">
                        –î–æ—Ö–æ–¥ (—Å—É–±—Å–∏–¥–∏–∏ + –∫–æ–º–º–µ—Ä—Ü–∏—è): 270 000 —Ä—É–±.<br>
                        –°—Ç–∞–≤–∫–∞: 6%<br>
                        –ù–∞–ª–æ–≥: 270 000 √ó 0.06 = <strong>16 200 —Ä—É–±.</strong>
                    </div>

                    <h3 class="font-bold text-lg border-b pb-2 mt-4">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∞—á–µ (8 —à–∞–≥–æ–≤)</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—é –≤ "–ù–∞–ª–æ–≥–æ–ø–ª–∞—Ç–µ–ª—å—â–∏–∫ –Æ–õ" –∏–ª–∏ –æ–Ω–ª–∞–π–Ω-–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏.</li>
                        <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ö–ë–ö –¥–ª—è –£–°–ù "–î–æ—Ö–æ–¥—ã".</li>
                        <li>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª XML.</li>
                        <li>–ü–æ–¥–ø–∏—Å–∞—Ç—å –£–ö–≠–ü —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è.</li>
                        <li>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –õ–ö –Æ–õ –Ω–∞ —Å–∞–π—Ç–µ –§–ù–° –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≠–î–û.</li>
                        <li>–î–æ–∂–¥–∞—Ç—å—Å—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –ø—Ä–∏–µ–º–µ.</li>
                        <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–µ—â–µ–Ω–∏–µ –æ –≤–≤–æ–¥–µ.</li>
                        <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –∞—Ä—Ö–∏–≤.</li>
                    </ol>
                    
                    <div class="mt-4 flex gap-2 flex-wrap">
                         <a href="#" class="text-blue-600 hover:underline text-sm"><i class="fas fa-external-link-alt"></i> –ü–æ—Ä—Ç–∞–ª –§–ù–°</a>
                         <a href="#" class="text-blue-600 hover:underline text-sm"><i class="fas fa-phone"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ö–æ–Ω—Ç—É—Ä–∞</a>
                    </div>
                </div>
            `,
            'payment': `
                <div class="space-y-4 text-center">
                    <div class="p-6 bg-red-50 rounded-xl border border-red-100">
                        <p class="text-gray-500 uppercase text-xs font-bold tracking-wider">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</p>
                        <p class="text-4xl font-bold text-[#c01530] my-2">16 200 ‚ÇΩ</p>
                        <p class="text-sm text-red-600">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ 28 –º–∞—Ä—Ç–∞ 2026</p>
                    </div>

                    <div class="text-left space-y-4">
                        <h3 class="font-bold text-lg border-b pb-2">üí≥ –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> –ß–µ—Ä–µ–∑ –ï–ù–° –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Ω–∞–ª–æ–≥–æ–ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> –ü–ª–∞—Ç–µ–∂–Ω—ã–º –ø–æ—Ä—É—á–µ–Ω–∏–µ–º –≤ –±–∞–Ω–∫-–∫–ª–∏–µ–Ω—Ç–µ</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> –ü–æ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª–µ–Ω–∏–∏ –±–∞–Ω–∫–∞</li>
                        </ul>

                        <h3 class="font-bold text-lg border-b pb-2 mt-4">üîê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–û–Ω–ª–∞–π–Ω)</h3>
                        <p class="text-sm text-gray-600">1. –ó–∞–π–¥–∏—Ç–µ –≤ –õ–ö –Æ–õ –§–ù–°.<br>2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª –ï–ù–°.<br>3. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ø–æ–ª–Ω–∏—Ç—å".<br>4. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É 16 200.<br>5. –û–ø–ª–∞—Ç–∏—Ç–µ –∫–∞—Ä—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.</p>
                    </div>
                </div>
            `,
            'minjust': `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <p class="font-bold text-blue-800">‚ÑπÔ∏è –í–∞–∂–Ω–æ: –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–∞—á–∞</p>
                        <p class="text-sm text-blue-700">–° 2025/2026 –≥–æ–¥–∞ –ú–∏–Ω—é—Å—Ç –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø–æ–¥–∞–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª –ù–ö–û.</p>
                    </div>

                    <h3 class="font-bold text-lg border-b pb-2">–≠—Ç–∞–ø—ã –ø–æ–¥–∞—á–∏</h3>
                    <ul class="space-y-3 text-sm">
                        <li class="flex gap-3">
                            <span class="bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
                            <span>–ó–∞–π—Ç–∏ –Ω–∞ –ø–æ—Ä—Ç–∞–ª unro.minjust.ru</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
                            <span>–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏ (–ï–°–ò–ê).</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
                            <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º—É (–û–ù0001 –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ê–ù–û –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏).</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
                            <span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">5</span>
                            <span>–ü–æ–¥–ø–∏—Å–∞—Ç—å –£–ö–≠–ü –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.</span>
                        </li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-2">–ö–æ–Ω—Ç–∞–∫—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ú–∏–Ω—é—Å—Ç–∞ –ø–æ –†–ë –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ.</p>
                </div>
            `,
            'rsv': `
                 <div class="space-y-4">
                    <p class="text-sm">–†–∞—Å—á–µ—Ç –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤—ã–º –≤–∑–Ω–æ—Å–∞–º (–†–°–í) –ø–æ–¥–∞–µ—Ç—Å—è –µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="font-bold text-sm">–ï—Å–ª–∏ –±—ã–ª–∏ –≤—ã–ø–ª–∞—Ç—ã:</p>
                            <p class="text-xs mt-1">–ó–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –†–∞–∑–¥–µ–ª 1 –∏ –†–∞–∑–¥–µ–ª 3 –Ω–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="font-bold text-sm">–ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –≤—ã–ø–ª–∞—Ç:</p>
                            <p class="text-xs mt-1">–°–¥–∞–µ—Ç—Å—è "–ù—É–ª–µ–≤–æ–π" –†–°–í. –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç, –†–∞–∑–¥–µ–ª 1 (–±–µ–∑ —Å—É–º–º) –∏ –†–∞–∑–¥–µ–ª 3 (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ).</p>
                        </div>
                    </div>
                    <p class="text-sm font-semibold mt-2">–°–ø–æ—Å–æ–±—ã —Å–¥–∞—á–∏:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600">
                        <li>–¢–ö–° (–ö–æ–Ω—Ç—É—Ä, –°–ë–ò–°, –¢–∞–∫—Å–∫–æ–º)</li>
                        <li>–ß–µ—Ä–µ–∑ —Å–∞–π—Ç –§–ù–° (–Ω—É–∂–Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏–ª–∏ –ö–≠–ü)</li>
                    </ul>
                </div>
            `,
            'default': `
                <p class="text-gray-600">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç—á–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ–π.</p>
                <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
                    <p class="text-sm"><strong>–°—Ä–æ–∫ —Å–¥–∞—á–∏:</strong> –°—Ç—Ä–æ–≥–æ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–ª–∏ —Ä–∞–Ω–µ–µ, –µ—Å–ª–∏ –¥–∞—Ç–∞ –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π (–ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å).</p>
                </div>
            `
        };

        // --- App Logic ---
        const app = {
            state: {
                view: 'table', // 'table' or 'timeline'
                filterMonth: '',
                filterStatus: 'all',
                currentReportId: null, // Track open report
                reports: [] // Will be populated in init
            },

            async init() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                try {
                    await db.init();
                    console.log('DB Initialized');
                } catch (e) {
                    console.error('Failed to init DB', e);
                }

                this.loadData();
                this.bindEvents();
                this.updateStats();
                this.render();
                this.setupDragAndDrop();
            },

            loadData() {
                // Load saved status overrides
                const savedStatuses = JSON.parse(localStorage.getItem('ano_report_statuses') || '{}');
                
                // Merge initial data with saved statuses
                this.state.reports = initialReports.map(report => {
                    if (savedStatuses[report.id]) {
                        return { ...report, status: savedStatuses[report.id] };
                    }
                    return report;
                });
            },

            bindEvents() {
                document.getElementById('btnTable').addEventListener('click', () => this.setView('table'));
                document.getElementById('btnTimeline').addEventListener('click', () => this.setView('timeline'));
                
                document.getElementById('monthFilter').addEventListener('change', (e) => {
                    this.state.filterMonth = e.target.value;
                    this.render();
                });

                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.state.filterStatus = e.target.value;
                    this.render();
                });

                // Keyboard escape to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
            },

            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
                });

                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    document.getElementById('fileInput').files = files; // Sync input
                    this.handleFileUpload({ files: files });
                }, false);
            },

            setView(viewName) {
                this.state.view = viewName;
                
                // Update Buttons
                const btnTable = document.getElementById('btnTable');
                const btnTimeline = document.getElementById('btnTimeline');
                
                if (viewName === 'table') {
                    btnTable.className = "flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-[#208091] text-white shadow-sm hover:bg-[#186572]";
                    btnTimeline.className = "flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-white text-[#134252] border border-gray-300 hover:bg-gray-50";
                } else {
                    btnTimeline.className = "flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-[#208091] text-white shadow-sm hover:bg-[#186572]";
                    btnTable.className = "flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-white text-[#134252] border border-gray-300 hover:bg-gray-50";
                }

                this.render();
            },

            getFilteredData() {
                return this.state.reports.filter(item => {
                    // Filter by Month
                    if (this.state.filterMonth) {
                        if (!item.date.startsWith(this.state.filterMonth)) return false;
                    }
                    
                    // Filter by Status
                    if (this.state.filterStatus !== 'all') {
                        if (item.status !== this.state.filterStatus) return false;
                    }
                    return true;
                });
            },

            updateStats() {
                const total = this.state.reports.length;
                
                const today = new Date();
                const currentMonthStr = today.toISOString().slice(0, 7);
                const currentMonthCount = this.state.reports.filter(r => r.date.startsWith(currentMonthStr)).length;

                // End of current quarter calculation
                const currentMonth = today.getMonth();
                const quarterEndMonth = Math.floor(currentMonth / 3) * 3 + 2; 
                const year = today.getFullYear();
                
                // Count active tasks (pending or process) expiring soon
                const quarterEndCount = this.state.reports.filter(r => {
                    const rDate = new Date(r.date);
                    return (r.status === 'pending' || r.status === 'process' || r.status === 'payment') && 
                           rDate >= today && 
                           rDate.getMonth() <= quarterEndMonth && 
                           rDate.getFullYear() === year;
                }).length;

                document.getElementById('statTotal').innerText = total;
                document.getElementById('statMonth').innerText = currentMonthCount;
                document.getElementById('statQuarter').innerText = quarterEndCount;
            },

            render() {
                const data = this.getFilteredData();
                const container = document.getElementById('viewContainer');
                
                // Filter notification
                const notification = document.getElementById('filterNotification');
                const msg = document.getElementById('filterMsg');
                if (this.state.filterMonth || this.state.filterStatus !== 'all') {
                    notification.classList.remove('hidden');
                    let statusText = this.state.filterStatus === 'all' ? '' : document.querySelector(`#statusFilter option[value="${this.state.filterStatus}"]`).text;
                    let monthText = this.state.filterMonth ? this.formatDate(this.state.filterMonth + '-01', {month: 'long', year: 'numeric'}) : '';
                    msg.innerText = `–§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—ë–Ω: ${monthText} ${statusText}. –ù–∞–π–¥–µ–Ω–æ –æ—Ç—á—ë—Ç–æ–≤: ${data.length}`;
                } else {
                    notification.classList.add('hidden');
                }

                if (this.state.view === 'table') {
                    this.renderTable(data, container);
                } else {
                    this.renderTimeline(data, container);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂–∏ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                this.updateAttachmentBadges(data);
            },

            async updateAttachmentBadges(data) {
                // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
                for (const item of data) {
                    try {
                        const count = await db.countFilesByReportId(item.id);
                        if (count > 0) {
                            // Update Table Badge
                            const tableBadge = document.getElementById(`badge-table-${item.id}`);
                            if (tableBadge) {
                                tableBadge.innerHTML = `<i class="fas fa-paperclip text-gray-400 text-sm ml-2" title="${count} —Ñ–∞–π–ª(–∞)"></i>`;
                            }
                            
                            // Update Timeline Badge
                            const timelineBadge = document.getElementById(`badge-timeline-${item.id}`);
                            if (timelineBadge) {
                                timelineBadge.innerHTML = `<i class="fas fa-paperclip text-gray-400 text-sm mr-2" title="${count} —Ñ–∞–π–ª(–∞)"></i>`;
                            }
                        }
                    } catch (e) {
                        // ignore
                    }
                }
            },

            renderTable(data, container) {
                if (data.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</div>';
                    return;
                }

                let html = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold tracking-wider">
                                    <th class="p-4">–î–∞—Ç–∞</th>
                                    <th class="p-4">–ß—Ç–æ —Å–¥–∞–≤–∞—Ç—å</th>
                                    <th class="p-4">–ö—É–¥–∞</th>
                                    <th class="p-4 hidden md:table-cell">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    <th class="p-4">–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;

                data.forEach(item => {
                    const statusConfig = this.getStatusConfig(item.status);
                    const isCritical = item.isCritical ? '<i class="fas fa-exclamation-triangle text-red-500 ml-1" title="–ö—Ä–∏—Ç–∏—á–Ω–æ"></i>' : '';
                    
                    html += `
                        <tr class="hover:bg-gray-50 cursor-pointer transition-colors" onclick="app.openModal(${item.id})">
                            <td class="p-4 whitespace-nowrap font-medium text-[#134252]">${this.formatDate(item.date)}</td>
                            <td class="p-4 font-semibold">
                                ${item.title} ${isCritical}
                                <span id="badge-table-${item.id}"></span>
                            </td>
                            <td class="p-4 text-sm text-gray-600">${item.where}</td>
                            <td class="p-4 hidden md:table-cell text-sm text-gray-500">${item.comment}</td>
                            <td class="p-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusConfig.class}">
                                    ${statusConfig.icon} ${statusConfig.text}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                container.innerHTML = html;
            },

            renderTimeline(data, container) {
                if (data.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</div>';
                    return;
                }

                // Group by month
                const groups = {};
                data.forEach(item => {
                    const monthKey = item.date.substring(0, 7); // YYYY-MM
                    if (!groups[monthKey]) groups[monthKey] = [];
                    groups[monthKey].push(item);
                });

                let html = `<div class="relative p-6 space-y-8"> <div class="timeline-line"></div>`;

                Object.keys(groups).sort().forEach(monthKey => {
                    const monthName = this.formatDate(monthKey + '-01', {month: 'long', year: 'numeric'});
                    
                    html += `
                        <div class="relative z-10">
                            <div class="inline-block bg-white border border-gray-200 px-3 py-1 rounded-full text-sm font-bold text-gray-600 mb-4 shadow-sm relative left-0">
                                ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}
                            </div>
                            <div class="space-y-4 pl-8">
                    `;

                    groups[monthKey].forEach(item => {
                        const statusConfig = this.getStatusConfig(item.status);
                        // Determine border color based on status
                        let borderColor = 'border-blue-300';
                        if (item.status === 'done') borderColor = 'border-[#208091]';
                        else if (item.status === 'payment') borderColor = 'border-[#a84b2f]';
                        else if (item.status === 'process') borderColor = 'border-yellow-400';
                        
                        html += `
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${borderColor} hover:shadow-md transition-shadow cursor-pointer relative" onclick="app.openModal(${item.id})">
                                <!-- Dot on line -->
                                <div class="absolute -left-[39px] top-1/2 transform -translate-y-1/2 w-4 h-4 rounded-full border-2 border-white ${statusConfig.dotClass}"></div>
                                
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs text-gray-400 font-bold mb-1">${this.formatDate(item.date)}</p>
                                        <h4 class="font-bold text-[#134252]">${item.title}</h4>
                                        <p class="text-sm text-gray-600 mt-1"><i class="fas fa-building mr-1 opacity-50"></i> ${item.where}</p>
                                    </div>
                                    <div class="flex items-center">
                                        <span id="badge-timeline-${item.id}"></span>
                                        <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">${statusConfig.text}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                });

                html += `</div>`;
                container.innerHTML = html;
            },

            getStatusConfig(status) {
                switch(status) {
                    case 'done': return { 
                        class: 'bg-green-100 text-[#208091] border-green-200', 
                        text: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', 
                        icon: '<i class="fas fa-check mr-1"></i>',
                        dotClass: 'bg-[#208091]'
                    };
                    case 'payment': return { 
                        class: 'bg-orange-100 text-[#a84b2f] border-orange-200', 
                        text: '–û–ø–ª–∞—Ç–∞', 
                        icon: '<i class="fas fa-ruble-sign mr-1"></i>',
                        dotClass: 'bg-[#a84b2f]'
                    };
                    case 'process': return { 
                        class: 'bg-yellow-100 text-yellow-800 border-yellow-200', 
                        text: '–í —Ä–∞–±–æ—Ç–µ', 
                        icon: '<i class="fas fa-spinner fa-spin mr-1"></i>',
                        dotClass: 'bg-yellow-400'
                    };
                    default: return { 
                        class: 'bg-blue-100 text-blue-800 border-blue-200', 
                        text: '–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç', 
                        icon: '<i class="far fa-clock mr-1"></i>',
                        dotClass: 'bg-blue-400'
                    };
                }
            },

            formatDate(dateStr, options) {
                const date = new Date(dateStr);
                const defaultOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                return date.toLocaleDateString('ru-RU', options || defaultOptions);
            },

            async openModal(id) {
                const item = this.state.reports.find(r => r.id === id);
                if (!item) return;

                this.state.currentReportId = id; // Set current ID

                const modal = document.getElementById('modalContent');
                const overlay = document.getElementById('modalOverlay');
                
                // Populate Header
                document.getElementById('modalTitle').innerText = item.title;
                document.getElementById('modalSubtitle').innerHTML = `<i class="far fa-calendar-alt mr-1"></i> ${this.formatDate(item.date)} &bull; ${item.where}`;
                
                // Setup Status Selector
                const select = document.getElementById('modalStatusSelect');
                select.innerHTML = `
                    <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>üìã –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç</option>
                    <option value="process" ${item.status === 'process' ? 'selected' : ''}>‚è≥ –í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="done" ${item.status === 'done' ? 'selected' : ''}>‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                    <option value="payment" ${item.status === 'payment' ? 'selected' : ''}>‚ö†Ô∏è –û–ø–ª–∞—Ç–∞</option>
                `;
                
                // Style selector to look like badge
                this.updateStatusSelectStyle(item.status);

                // Determine Content
                let contentHTML = '';
                
                // Logic to select template based on title or ID
                if (item.title.includes('–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è –£–°–ù 2025')) contentHTML = contentTemplates['usn2025'];
                else if (item.status === 'payment') contentHTML = contentTemplates['payment'];
                else if (item.title.includes('–ú–∏–Ω—é—Å—Ç')) contentHTML = contentTemplates['minjust'];
                else if (item.title.includes('–†–°–í')) contentHTML = contentTemplates['rsv'];
                else contentHTML = contentTemplates['default'];

                // Inject Basic Comment if exists and not payment (payment has its own structure)
                if (item.comment && item.status !== 'payment') {
                    contentHTML = `<div class="mb-4 bg-gray-50 p-3 rounded text-sm border border-gray-200 italic"><i class="fas fa-comment-alt text-gray-400 mr-2"></i> ${item.comment}</div>` + contentHTML;
                }

                document.getElementById('modalBody').innerHTML = contentHTML;
                
                // Reset/Prepare UI for attachments
                document.getElementById('fileList').innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>';
                document.getElementById('uploadError').classList.add('hidden');

                // Show
                overlay.classList.remove('hidden');
                
                // Async Load attachments after showing modal
                await this.renderAttachments();

                // Small timeout to allow display:block to apply before opacity transition
                setTimeout(() => {
                    modal.classList.remove('scale-95', 'opacity-0');
                    modal.classList.add('scale-100', 'opacity-100');
                }, 10);
            },

            closeModal(e) {
                if (e && e.target.id !== 'modalOverlay') return; // Only close if overlay clicked directly (or called via button)
                
                this.state.currentReportId = null; // Clear ID

                const modal = document.getElementById('modalContent');
                const overlay = document.getElementById('modalOverlay');

                // Start hide animation
                modal.classList.remove('scale-100', 'opacity-100');
                modal.classList.add('scale-95', 'opacity-0');

                // Wait for animation then hide overlay and refresh lists
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    this.updateStats(); // Update stats in case status changed
                    this.render(); // Re-render table/timeline to show new status color (and refresh badges)
                }, 300);
            },

            changeStatus(newStatus) {
                const reportId = this.state.currentReportId;
                if (!reportId) return;

                // Update local state
                const reportIndex = this.state.reports.findIndex(r => r.id === reportId);
                if (reportIndex !== -1) {
                    this.state.reports[reportIndex].status = newStatus;
                    
                    // Save to localStorage (Status is small, keep in LS for speed/simplicity)
                    const savedStatuses = JSON.parse(localStorage.getItem('ano_report_statuses') || '{}');
                    savedStatuses[reportId] = newStatus;
                    localStorage.setItem('ano_report_statuses', JSON.stringify(savedStatuses));
                    
                    // Update UI immediately (Select box style)
                    this.updateStatusSelectStyle(newStatus);
                }
            },

            updateStatusSelectStyle(status) {
                const select = document.getElementById('modalStatusSelect');
                const config = this.getStatusConfig(status);
                // Apply classes dynamically
                select.className = `text-sm font-semibold rounded-full px-3 py-1 border-2 outline-none cursor-pointer transition-colors ${config.class}`;
            },

            // --- Attachment Logic (Updated for IndexedDB) ---

            async deleteAttachment(fileId) {
                if (!this.state.currentReportId) return;
                
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) return;

                try {
                    await db.deleteFile(fileId);
                    await this.renderAttachments(); // Refresh the list in modal
                } catch (e) {
                    console.error("Delete failed", e);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " + e.message);
                }
            },

            handleFileUpload(input) {
                if (!input.files || input.files.length === 0) return;
                if (!this.state.currentReportId) return;

                const file = input.files[0];
                if (file.size > 50 * 1024 * 1024) {
                    if (!confirm("–§–∞–π–ª –±–æ–ª—å—à–µ 50–ú–ë. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
                        input.value = '';
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const fileData = {
                        id: Date.now(), // Unique ID
                        reportId: this.state.currentReportId,
                        name: file.name,
                        type: file.type,
                        size: (file.size / 1024).toFixed(1) + ' KB',
                        content: e.target.result, // Base64 string
                        date: new Date().toLocaleDateString('ru-RU')
                    };

                    try {
                        await db.addFile(fileData);
                        await this.renderAttachments();
                        if (input.value) input.value = ''; 
                    } catch (err) {
                        console.error("Save failed", err);
                        document.getElementById('uploadError').innerText = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message;
                        document.getElementById('uploadError').classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            },

            async renderAttachments() {
                const reportId = this.state.currentReportId;
                if (!reportId) return;

                const container = document.getElementById('fileList');
                
                try {
                    const files = await db.getFilesByReportId(reportId);
                    
                    if (files.length === 0) {
                        container.innerHTML = '<div class="text-center py-2 text-gray-400 text-sm">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>';
                        return;
                    }

                    let html = '';
                    files.forEach(file => {
                        // Determine icon
                        let icon = 'fa-file';
                        if (file.type.includes('pdf')) icon = 'fa-file-pdf text-red-500';
                        else if (file.type.includes('image')) icon = 'fa-file-image text-purple-500';
                        else if (file.type.includes('word') || file.type.includes('document')) icon = 'fa-file-word text-blue-500';
                        else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'fa-file-excel text-green-500';

                        // IMPORTANT: Pass ID correctly to delete function
                        html += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 group hover:border-[#208091] transition-colors">
                                <div class="flex items-center overflow-hidden">
                                    <i class="fas ${icon} text-xl mr-3 flex-shrink-0"></i>
                                    <div class="min-w-0">
                                        <p class="text-sm font-medium text-gray-700 truncate" title="${file.name}">${file.name}</p>
                                        <p class="text-xs text-gray-400">${file.date} ‚Ä¢ ${file.size}</p>
                                    </div>
                                </div>
                                <div class="flex items-center ml-2 space-x-2">
                                    <a href="${file.content}" download="${file.name}" class="p-2 text-gray-400 hover:text-[#208091] transition-colors" title="–°–∫–∞—á–∞—Ç—å">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button onclick="app.deleteAttachment(${file.id})" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } catch (e) {
                    console.error("Render failed", e);
                    container.innerHTML = '<div class="text-red-500 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤</div>';
                }
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
